<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fudi</title>

<!-- Sets initial viewport load and disables zooming  -->
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width" />

<!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="mobile-web-app-capable" content="yes">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<link href="css/styles.css" rel="stylesheet">
<style>
.nav-tabs li{ width:auto; }
.nav-tabs li{ display:inline-block; }
.nav-tabs a, .nav-tabs .active > a{font-size:15px !important;  }
.nav-tabs>li>a{ border:none; }
h4.names_label label{ font-weight: normal !important; margin:3px 5px }
div.byChef div{ margin:5px 0 6px 0; }
div.byChef .label-primary{ font-weight:normal; background-color:#ECF8FF; color:#000; border-radius:0; font-size:12px;   }
#chef-foods{ margin-top:0 }
table.lessPadding td{ padding:4px 6px !important;  } 
@media (min-width:320px) and (max-width:370px)
{
	.nav>li>a{ padding:10px 8px; border:none; }
	.nav-tabs a, .nav-tabs .active > a{font-size:14px !important } 
}

</style>
</head>
<body id="wrapper">
<div id="sidebar-wrapper">
	<nav id="nav">
		<ul class="sidebar-nav nav" id="navRight">
			<li class="L0 menu-heading"><strong><a href="#"><i class="icon-user"></i> <span data-bind="text: lang.Foodie"></span></a></strong></li>
			<li class="L2"><a class="sub" href="map.html"><i class="icon-pointer-advice"></i> <span data-bind="text: lang.mnuChefs"></span></a></li>
			<li class="L2"><a class="sub" href="user-profile.html"><i class="icon-user"></i> <span data-bind="text: lang.MyProfile"></span></a></li>
			<li class="L2"><a class="sub" href="payment-options.html"><i class="icon-credit-cards"></i> <span data-bind="text: lang.PO"></span></a></li>
			<li class="L2"><a class="sub" href="reservations.html"><i class="icon-tray"></i> <span data-bind="text: lang.MyOrders"></span></a></li>
			<li class="L2"><a class="sub" href="notifications.html"><i class="icon-mail"></i> <span data-bind="text: lang.Notifications"></span></a></li>
			<!--<li class="L2"><a class="sub" href="events-list.html"><i class="fa fa-glass"></i> <span data-bind="text: lang.Events"></span></a></li>-->
			<li class="L0 menu-heading"><strong><a href="#"><i class="icon-chef"></i> <span data-bind="text: lang.CHEF"></span></a></strong></li>
			<li class="L2 noChef"><a class="sub" href="chef-profile-edit.html"><i class="icon-chef"></i> <span data-bind="text: lang.BecomeaChef"></span></a></li>
			<li class="L2 isChef pChef"><a class="sub" href="chef-profile-edit.html"><i class="icon-chef"></i> <span data-bind="text: lang.ChefProfile"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-dishes.html"><i class="icon-food"></i> <span data-bind="text: lang.ManageDishes"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-calendar-set.html"><i class="icon-clock"></i> <span data-bind="text: lang.Schedule"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="delivery-schedule.html"><i class="icon-calendar"></i> <span data-bind="text: lang.DeliverySchedule"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="ps-schedule.html"><i class="icon-calendar-1"></i> <span data-bind="text: lang.PSmenu"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-reservations.html"><i class="icon-reserve"></i> <span data-bind="text: lang.ChefReservations"></span></a></li>
			<!--<li class="L2 isChef"><a class="sub" href="chef-events.html"><i class="fa fa-glass"></i> <span data-bind="text: lang.eventResv"></span></a></li>-->
			<li class="L2 isChef"><a class="sub" href="withdraw-money-chef.html"><i class="icon-withdraw"></i> <span data-bind="text: lang.WithdMon"></span></a></li>
			<li class="L1"><a href="settings.html"><i class="icon-gear"></i> <span data-bind="text: lang.Settings"></span></a></li>
			<li class="L1"><a href="about.html"><i class="icon-about"></i> <span data-bind="text: lang.AboutFudi"></span></a></li>
			<li class="L1"><a href="register.html?do=logout"><i class="icon-logout"></i> <span data-bind="text: lang.Logout"></span></a></li>
		</ul>
	</nav>
</div>

<!-- Wrap all non-bar HTML in the .content div (this is actually what scrolls) -->
<div class="container">
	<div id="chef-page" class="content">
		<h1 id="menu-button"> <a id="menu-toggle" href="#" class="btn-menu toggle"> <i class="fa fa-bars"></i> </a>
		<p class="pageTitle" xdata-bind="text: lang.ManageD">Event Reservations</p>
		</h1>
		
		
		
		
		
		
		
		
		
		
		
		
		<div id="chef-foods">
		<div class="food-listing hidden">
			<div class="faEventDiv col-xs-2"><i class="fa fa-3x fa-glass"></i></div>
			<div class=" col-xs-10 no-lft-padding no-right-padding">
				<div class="food-info-body">
					<h4 class="dishTitle">...</h4>
					
					<div class="byChef">..</div>
					
				</div>
			</div>
		</div>
		<div class="aLoading text-center" style="display:none"><img src="images/loading.gif" sytle=" margin: 0 auto;" /></div>
	</div>
		
		
		
	</div>
</div>
<br />
<br />
<br />

<div class="modal fade" id="popPSOrder" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.DeliveryOrder">Join Event</h4>
			</div>
			<div class="modal-body">
				<form method="post" id="frmReserve3">
					<div id="divCheckList">
					
					</div>
					<h4 style="color:#666;" id="h4Ad"><span xdata-bind="text: lang.Deliverycharges2">Entry Charges</span> : <span id="PS_Adcharges">$0.00</span></h4>
					<h2 style="color:#C00"><span data-bind="text: lang.Total">Total</span> : <span id="d_total">$40.00</span></h2>
				</form>
			</div>
			<div class="modal-footer">
				<button id="btnStartPay" type="button" class="btn btn-primary" xdata-bind="text: lang.OrderNow">Join Now!</button>
			</div>
		</div>
	</div>
</div>


<br />
<br />
<br />
<div class="modal fade" id="popDetail" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Event Details</h4>
			</div>
			<div class="modal-body">
				
					<div id="infoDiv">
					
					</div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
				<button id="btnAdd" type="button" class="btn btn-primary" xdata-bind="text: lang.Save">Join This Event!</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="popPermission" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Permission Required</h4>
			</div>
			<div class="modal-body">
				
				<p>This event is private and cannot be viewed by everyone. If you are interested, click the button below to ask event organizer for access.</p>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
				<button id="btnAskPermission" type="button" class="btn btn-primary" xdata-bind="text: lang.Save">Request Access</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="popOrders" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Event Orders</h4>
			</div>
			<div class="modal-body">
				
				<div id="spUsersBody"></div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
			</div>
		</div>
	</div>
</div>

<!-- Script --> 
<script type="text/javascript" src="cordova.js"></script> 
<script src="js/jquery-1.11.3.min.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src="js/jquery.validate.min.js"></script>
<script src="js/moment.min.js"></script>
<script src="js/jquery.qrcode.js"></script> 
<script src="js/qrcode.js"></script> 
<script src='js/knockout-3.4.0.js'></script> 
<script src="js/common.js"></script> 
<script>

var thisEvent;
var thisEventIndex;
var eventData;
var delId = false;
var quietLoad = false;
var Total = 0.0; 

$(document).ready(function(e) {
	
	loadPageData();
	
	$('#chef-foods').on('click', '.btnViewOrders',function(){
		
		var idx = $(this).data('event-index');
		
		
		var H = '';
		for (var i = 0; i < eventData[idx].orders.length ; i++){
			H += '<div class="table-responsive noBorder"><table class="table lessPadding">';
			H += '<tr class="info"><td colspan="4"><i class="fa fa-user"></i> <strong>'+eventData[idx].orders[i].first_name+' '+eventData[idx].orders[i].last_name+'</strong></td></tr>';
			H += '<tr><td>#</td><td>Dish</td><td>Qty</td><td>Price</td></tr>';
			var dishes = eventData[idx].orders[i].dishes;
			for (var j = 0; j < dishes.length ; j++){
				H += '<tr><td>'+(j+1)+'</td><td>'+dishes[j].name+'</td><td>'+dishes[j].qty+'</td><td>$'+dishes[j].price+'</td></tr>';
			}
			H += '</table></div>';
		}
		
		
		$('#spUsersBody').html(H);
		$('#popOrders').modal();
	});
		
	$('.tab-content').on('click', '.btnSelect',function(){
		var id = $(this).data('id');
		
		for (var i = 0; i < eventData.length; i++){
			if( eventData[i].id == id ){
				thisEvent = eventData[i];
				thisEventIndex = i;
				break;
			}
		}
		
		var event_owner = (thisEvent.creator_id == localStorage.getItem('userId'));
		
		if( thisEvent.availability == 'Private' && !event_owner  ){
			if( thisEvent.access == 'D'){
				BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
				BAlert.find('.modal-body').html('<p class="text-danger">Sorry, access denied by the event organizer.</p>');
				BAlert.modal();
				return false;
			}
			
			if( thisEvent.access != 'A' ){
				$('#popPermission').modal();
				return false;
			} 
		}
		
		var mo = moment( thisEvent.event_date+' '+thisEvent.event_time, 'YYYY-MM-DD HH:mm:ss' );
		mo.format('MMM D, YYYY (ddd) [at] h:mma')
		var H = '<em>Event Title:</em><h4 style="margin-top:4px;">'+thisEvent.title+'</h4>';
		H += '<table class="table table-responsive">';
		H += '<tr><td><strong>Organizer:</strong> </td><td>'+thisEvent.creator_name+'</td></tr>';
		H += '<tr><td><strong>Date:</strong> </td><td>'+mo.format('MMM D, YYYY (ddd)')+'</td></tr>';
		H += '<tr><td><strong>Time:</strong> </td><td>'+mo.format('h:mma')+'</td></tr>';
		H += '<tr><td><strong>Availability:</strong> </td><td>'+thisEvent.availability+'</td></tr>';
		H += '<tr><td><strong>Entry Fee:</strong> </td><td>$'+thisEvent.entry_fee+'</td></tr>';
		H += '<tr><td><strong>Address:</strong> </td><td>'+thisEvent.address+'</td></tr>';
		H += '</table>';
		
		$('#btnAdd').show();
		
		/*
		if( event_owner == true ){
			
			H += '<h4>Users Attending</h4><h4 class="names_label">';
			for (var i = 0; i < thisEvent.Users.length ; i++){
				H += '<label class="label label-success">'+thisEvent.Users[i].first_name+' '+thisEvent.Users[i].last_name+'</label>';
			}
			H += '</h4>';
			$('#btnAdd').hide();
		}
		*/
		
		
		if( event_owner == true ){
			H += '<h4>Users Attending</h4><h4 class="names_label">';
			var isEmpty = true;
			for (var i = 0; i < thisEvent.Users.length ; i++){
				H += '<label class="label label-success">'+thisEvent.Users[i].first_name+' '+thisEvent.Users[i].last_name+'</label>';
				isEmpty = false;
			}
			H += '</h4>';
			
			if( isEmpty == true )		H += '<em>None so far.</em>';
			
			
			$('#btnAdd').hide();
		}
		
		
		
		
		$('#infoDiv').html(H);
		$('#popDetail').modal();
	});
	
	
	
	$('#btnStartPay').on('click',function(){
		if( $('#divCheckList input:checked').length == 0 ){
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">Please select atleast one dish to proceed.</p>');
			BAlert.modal();
			return;
		}
		
		var dishes = [];
		var Total = 0.00;
		$('#divCheckList [type=checkbox]').each(function(index, element) {
			if($(this).is(':checked')){
				qty = $('#aQty'+$(this).val()).val();
				dishes.push( {'id':$(this).val(), 'chef_id': $(this).data('chef_id'), 'name': $(this).data('name'), 'qty':qty,'price': $(this).data('price') } ); 
				Total = Total + parseFloat($(this).data('price')) * parseFloat(qty); 
			}	
		});
		console.log(thisEvent);
		var formData = { 	'event_id' : thisEvent.id,
								'userId' : localStorage.getItem('userId'),
								'userToken' : localStorage.getItem('userToken'),
								'dishes' : dishes,
								'amount' : Total,
								'entry_fee' : thisEvent.entry_fee 
							};

		
		//formData += '&userToken=' + localStorage.getItem('userToken');
		$.ajax({
			type: "POST", dataType: 'json', url: ServerAjax+"?h=joinEvent", data: formData,
			beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
			complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError
			).done(function(data){
				if (data.Success == 'true') {
					
					document.location = 'payment-options-select.html?Type=Event&ResId='+data.joinId+'&Amount='+Total;
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
		}); // ajax	
		
		
		
	});
	
	
	
	$('.btnShowAdd').on('click',function(){
		document.location = 'event-1.html';
	});
	
	/*
	$('#frmReserve').validate({
		errorPlacement: function(error, element) {},
		submitHandler: function(form) {
			
			var Flag = 0;
			if( $('#chkAV1').prop('checked') == true )  Flag = Flag | 1;
			if( $('#chkAV2').prop('checked') == true )  Flag = Flag | 2;
			if( $('#chkAV4').prop('checked') == true )  Flag = Flag | 4;
			$('#hdAvailability').val(Flag);
			
			
			formData = $(form).serialize();
			formData += '&userToken=' + localStorage.getItem('userToken');
			$.ajax({
				type: "POST", dataType: 'json', url: ServerAjax+"?h=addEditDish", data: formData,
				beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
				complete: function() { waitingDialog.hide(); },
				}).fail(  ajaxError
				).done(function(data){
					if (data.Success == 'true') {
						$('#popDetail').modal('hide');
						BAlert.find('.modal-header h3').html('<i class="fa check"></i>'+cLan.Success);
						BAlert.find('.modal-body').html('<p class="text-success">'+cLan['202']+'</p>');
						BAlert.modal();
						quietLoad = true;
						loadDishes(chef_id);
						//loadDishes(localStorage.getItem('userId'));
					} else { 
						ErrorModalWithParm(data);
					}
					if (data.JS) { eval(data.JS); }
				
			}); // ajax	
		
		}// submit handler
	});
	*/
	
	$('#divCheckList').on('change', 'input',function(){
		if( $(this).is(':checked')){
			$(this).parent('li').find('.spDishD').show(200);
		}else{
			$(this).parent('li').find('.spDishD').hide(150);	
		}
		getTotal();
	});
	
	
	$('#btnScan').on('click',function(){
		try{
			cordova.plugins.barcodeScanner.scan(QRonSuccess, QRFailure);
		}catch(err) {
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.UnableQR+'</p>');
			BAlert.modal();	
		}
	});

});

function QRonSuccess(result){
	
	if( result.cancelled == true ){
		return false; 	
	}				 
	var code = result.text;
	if(code.charAt(0) == 'F'){
		code = code.substr(1);	 // Remove F
		code = code.split(':');
		var id = parseInt(code[0]);
		var key = parseInt(code[1]);
		if(empty(id) || empty(key)){
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.InvalidQR+'</p>');
			BAlert.modal();		
		}else{
		
			var formData = {
				userId: localStorage.getItem('userId'),
				userToken: localStorage.getItem('userToken'),
				Fcode: key
			};
			$.ajax({
				type: "POST", dataType: 'json', url: ServerAjax+"?h=eventQRScan", data: formData,
				beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
				complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError )
			.done(function(data){
				if (data.Success == 'true') {
					
					
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
			}); // ajax	
		
		
			
		}
	}else{
		BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
		BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.InvalidQR+'</p>');
		BAlert.modal();	
	} 
}
function QRFailure(message){
	BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
	BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.UnableQR+': '+message+'</p>');
	BAlert.modal();	
}

function getTotal(){
	$('#divCheckList [type=checkbox]').each(function(index, element) {
		if($(this).is(':checked')){
			Total = Total + $(this).data('price') * $('#aQty'+$(this).val()).val(); 
		}	
	});
	Total +=  parseFloat(thisEvent.entry_fee); 
	$('#d_total').html('$'+Total.toFixed(2));
}

function loadPageData(){
	var formData = {
				userId: localStorage.getItem('userId'),
				userToken: localStorage.getItem('userToken'), 
				};
				
	$.ajax({
		type: "POST", dataType: 'json', url: ServerAjax+"?h=getChefEvents", data: formData,
		beforeSend: function() { $('div.aLoading').show();  },
		complete: function() { $('div.aLoading').hide(); },
	}).fail(  ajaxError )
	.done(function(data){
		if (data.Success == 'true') {
			if(!empty(data.Events)){
				eventData = data.Events;
				
				$('div.food-listing').not('.hidden').remove();
				
				$DTemp = $('.food-listing');
				for (var i = 0; i < eventData.length; i++) {
					$copy = $DTemp.clone().removeClass('hidden');
					$copy.addClass( 'ID'+eventData[i].id );
					//$copy.find('img.img-responsive').prop('src', 'http://mobileapi.foodiesys.com/foodie-mssql/pics/'+eventData[i].image1);
					$copy.find('h4.dishTitle').html( eventData[i].title );
					
					
					var T = '';
					var Dst = distance( localStorage.getItem('lat'), localStorage.getItem('lng'), eventData[i].lat, eventData[i].lng, 'M');
					var mo = moment( eventData[i].event_date+' '+eventData[i].event_time, 'YYYY-MM-DD HH:mm:ss' );
					
					T += 'Address: '+eventData[i].address + ' &nbsp; <i class="fa fa-lg fa-map-marker"></i>' ;	
					T += '<div>('+Dst.toFixed(1)+' miles away)</div>';
					T += '<div>'+cLan.Time+': '+ mo.format('MMM D, YYYY (ddd) [at] h:mma') +'</div>';
					T += '<div>Organizer : '+ eventData[i].creator_name +'</div>';
					//T += ' <div>'+eventData[i].availability+' Event</div>';	
					
					var chefData = JSON.parse(eventData[i].chef_data);
					var dishNames = '';
					for(var j=0; j<chefData.length; j++){
						if( chefData[j].id == localStorage.getItem('userId') ){
							if(!empty(chefData[j].dishes)){
								for(var k=0; k<chefData[j].dishes.length; k++){
									dishNames += '<span class="label label-primary">'+chefData[j].dishes[k].name +'</span> ';
								}
							}	
						}
					}
					
					if(!empty(dishNames)){
						T += '<div>Dishes to be made :<br>'+ dishNames +'</div>';	
					}
					
					if(empty(eventData[i].orders)){
						T += '<div>Orders : 0</div>';	
					}else{
						
						T += '<div><button data-event-index="'+i+'" class="btn btnViewOrders btn-sm btn-success">View Orders ('+eventData[i].orders.length+')</button> </div>';	
					}
					//T += '<button type="button" class="btn btn-warning btn-sm btnSelect pull-right" data-id="'+eventData[i].id+'">View Details</button>';
					
					$copy.find('div.byChef').html( T );
					$('#chef-foods').append($copy);
					
					
					
				}
				//$DTemp.remove();
			}else{
				//$('#chef-foods').html('<center>No Events Found!</center>');
			}
		}else { 
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+data.Msg+'</p>');
			BAlert.modal();
		}
		if (data.JS) { eval(data.JS); }
	
	}); // ajax	
}



function loadDishes(){
	var H = '';
	var chefs = JSON.parse(thisEvent.chef_data);
	for(var i=0; i<chefs.length; i++){
		var ch = chefs[i];
		H += '<strong><i class="icon-chef"></i> &nbsp; '+ch.company+'</strong><ul class="list-group">';
		for(var j=0; j< ch.dishes.length; j++){
			var dsh = ch.dishes[j];
			H += '<li class="list-group-item">'+
					'<input type="checkbox" data-price="'+dsh.price+'" data-name="'+dsh.name+'" data-chef_id="'+ch.id+'" value="'+dsh.id+'"> '+dsh.name+
					'<div class="spDishD">'+cLan.Price+' : $'+dsh.price+ ' &nbsp; '+cLan.Qty+' : <input id="aQty'+dsh.id+'" type="number" value="1" min="1" max="50" step="1" class="input-sm inline" /></div></li>';
		}
		H += '</ul>';	
	}
	return H;
}

</script>
</body>
</html>