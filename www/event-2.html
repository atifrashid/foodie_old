<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fudi</title>

<!-- Sets initial viewport load and disables zooming  -->
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width" />

<!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="mobile-web-app-capable" content="yes">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<link href="css/styles.css" rel="stylesheet">
<link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<style>
.bootstrap-datetimepicker-widget table td.active, .bootstrap-datetimepicker-widget table td.active:hover {
	background-color: #fff;
	color: #666;
	text-shadow: 0 -1px 0 rgba(0,0,0,0.25);
}
.bootstrap-datetimepicker-widget table td.green, .bootstrap-datetimepicker-widget table td.green:hover {
	background-color: #5CB85C !important;
	color: #FFF !important;
	text-shadow: 0 -1px 0 rgba(0,0,0,0.25) !important;
}
.bootstrap-datetimepicker-widget table td, .bootstrap-datetimepicker-widget table th {
	border-radius: 0;
}
</style>
</head>
<body id="wrapper">
<div id="sidebar-wrapper">
	<nav id="nav">
		<ul class="sidebar-nav nav" id="navRight">
			<li class="L0 menu-heading"><i class="icon-user"></i><strong><a href="#" data-bind="text: lang.Foodie"></a></strong></li>
			<li class="L2"><i class="icon-pointer-advice"></i><a class="sub" href="map.html" data-bind="text: lang.mnuChefs"></a></li>
			<li class="L2"><i class="icon-user"></i><a class="sub" href="user-profile.html" data-bind="text: lang.MyProfile"></a></li>
			<li class="L2"><i class="icon-credit-cards"></i><a class="sub" href="payment-options.html" data-bind="text: lang.PO"></a></li>
			<li class="L2"><i class="icon-tray"></i><a class="sub" href="reservations.html" data-bind="text: lang.MyOrders"></a></li>
			<li class="L2"><i class="icon-mail"></i><a class="sub" href="notifications.html" data-bind="text: lang.Notifications"></a></li>
			<li class="L2"><i class="fa fa-glass"></i><a class="sub" href="events-list.html" data-bind="text: lang.Events"></a></li>
			<li class="L0 menu-heading"><i class="icon-chef"></i><strong><a data-bind="text: lang.CHEF" href="#"></a></strong></li>
			<li class="L2 noChef"><i class="icon-chef"></i><a class="sub" data-bind="text: lang.BecomeaChef" href="chef-profile-edit.html"></a></li>
			<li class="L2 isChef pChef"><i class="icon-chef"></i><a class="sub" data-bind="text: lang.ChefProfile" href="chef-profile-edit.html"></a></li>
			<li class="L2 isChef"><i class="icon-food"></i><a class="sub" data-bind="text: lang.ManageDishes" href="chef-dishes.html"></a></li>
			<li class="L2 isChef"><i class="icon-clock"></i><a class="sub" data-bind="text: lang.Schedule" href="chef-calendar-set.html"></a></li>
			<li class="L2 isChef"><i class="icon-calendar"></i><a class="sub" data-bind="text: lang.DeliverySchedule" href="delivery-schedule.html"></a></li>
			<li class="L2 isChef"><i class="icon-calendar-1"></i><a class="sub" data-bind="text: lang.PSmenu" href="ps-schedule.html"></a></li>
			<li class="L2 isChef"><i class="icon-reserve"></i><a class="sub" data-bind="text: lang.ChefReservations" href="chef-reservations.html"></a></li>
			<li class="L2 isChef"><i class="icon-withdraw"></i><a class="sub" data-bind="text: lang.WithdMon" href="withdraw-money-chef.html"></a></li>
			<li class="L1"><i class="icon-gear"></i><a href="settings.html" data-bind="text: lang.Settings"></a></li>
			<li class="L1"><i class="icon-about"></i><a href="about.html" data-bind="text: lang.AboutFudi"></a></li>
			<li class="L1"><i class="icon-logout"></i><a href="register.html?do=logout" data-bind="text: lang.Logout"></a></li>
		</ul>
	</nav>
</div>
<div id="user-profile-page" class="content">
	<h1 id="menu-button"> <a id="menu-toggle" href="#" class="btn-menu toggle"> <i class="fa fa-bars"></i> </a>
		<p class="pageTitle" style="font-size:24px" xdata-bind="text: lang.PSmenu">Create Event</p>
	</h1>
	<form id="user-form">
		<div id="topAlert" style="" class="alert alert-info"><span xdata-bind="text: lang.FSP"> Following chefs are avaiblae for your event as per your date and address specifications. Please pick the chef(s) from below list for your event. </span></div>
		
		
	<div id="chef-foods">
		<div class="food-listing hidden">
			<div class=" col-xs-3 col-sm-2 no-lft-padding"> <img class="img-responsive img-circle media-object pull-left" src="images/food-1.png" /> </div>
			<div class=" col-xs-9 col-sm-10 no-right-padding" style="padding-left:0">
				<div class="food-info-body">
					<h4 class="dishTitle">...</h4>
					
					<div class="byChef">..</div>
					
				</div>
			</div>
		</div>
		<div class="aLoading text-center" style="display:none"><img src="images/loading.gif" sytle=" margin: 0 auto;" /></div>
	</div>
		
		
		
		
		<button type="button" id="btn-submit" class="btn btn-positive btn-block btn-submit" xdata-bind="text: lang.Save">Create Event</button>
	</form>
</div>
<br />
<br />
<br />


<div class="modal fade" id="popPSOrder" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.DeliveryOrder">Select Personal Chef</h4>
			</div>
			<div class="modal-body">
				<form method="post" id="frmReserve3">
					<div id="StepPS2">
						<h4  data-bind="text: lang.SelectDishes"></h4>
						<div id="spAvDishesPS">
							<ul class="list-group">
							</ul>
						</div>
						
						<div class="form-group">
							<label _data-bind="text: lang.Time">Additional Stay (hours)</label>
							<div class="">
								<input type="number" id="additionalStay" name="additionalStay" class="form-control" value="0" />
							</div>
						</div>
						<h4 style="color:#666; display:none" id="h4Ad"><span xdata-bind="text: lang.Deliverycharges2">Additional Stay Charges</span> : <span id="PS_Adcharges">$0.00</span></h4>
						<h4 style="color:#666"><span xdata-bind="text: lang.Deliverycharges2">Travel Charges</span> : <span id="PS_charges">$0.00</span></h4>
						
					</div>
					<input type="hidden" id="hPS_charges" name="hPS_charges">
					<input type="hidden" id="gPSAddress" name="gPSAddress">
				</form>
			</div>
			<div class="modal-footer">
				<button id="btnOrderPS" type="button" class="btn btn-primary" xdata-bind="text: lang.OrderNow">OK</button>
			</div>
		</div>
	</div>
</div>

<script src="cordova.js"></script> 
<script src="js/jquery-1.11.3.min.js"></script> 
<script src="js/jquery.validate.min.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src='js/knockout-3.4.0.js'></script> 
<script src="js/common.js"></script> 
<script src="js/moment.min.js"></script> 
<script src="js/bootstrap-datetimepicker.min.js"></script> 
<script>

var thisChef;
var dishData;
var DishAv;
var DishAvO = {};
var thisDate;
var eventOb ; 

$(document).ready(function(e) {
	
	eventOb = JSON.parse(localStorage.getItem('eventData'));
	if(empty(eventOb)){
		document.location = 'event-1.html';	
	}
	
	loadPageData();

	$('#chef-foods').on('click','.btnSelect',function(){
		thisChef = $(this).data('id');
		loadDishes( thisChef );
		$('#popPSOrder').modal();	
	});
	
	$('#btnAdd').on('click',function(){
		$('#frmReserve').submit();
	});
	
	$('#btnOrderPS').on('click',function(){ // Select dishes in popup
		
		var dishes = [];
		var travel_charges = parseFloat($('#hPS_charges').val());
		$('#spAvDishesPS [type=checkbox]').each(function(index, element) { // Loop thoough each dish checkbox
			if($(this).is(':checked')){
				dishes.push( {'id':$(this).val(), 'name': $(this).data('name'), 'price': $(this).data('price') } ); 
			}	
		});
		
		if(!empty(dishes)){
			var thisChefRec;
			chData.forEach(function (el, i, arr){ 
    			if( [el.id] == thisChef )	thisChefRec = el;
			});
			thisChefRec.dishes = dishes;
			
			
			if(!empty(eventOb.chefs)){ // Already have checf in event
				var chefIndex = -1;
				eventOb.chefs.forEach(function (el, i, arr){
					if( el.id == thisChef ) chefIndex = i; 
				});
				if( chefIndex == -1){
					eventOb.chefs.push(thisChefRec);
				}else{
					eventOb.chefs[chefIndex] = thisChefRec;	
				}
			}else{
				var ArChefs = [];
				ArChefs.push(thisChefRec);
				eventOb.chefs = ArChefs;
			}
		}else{ // no disht, so remove chef from event.
			eventOb.chefs.forEach(function (el, i, arr){
				if( el.id == thisChef ){
					eventOb.chefs.splice( i, 1 );
				}
			});
		}
		console.log(eventOb);
		
		$('#chef-foods .food-listing').removeClass('Selected').find('.btnSelect').html('Select Chef');				
		eventOb.chefs.forEach(function (el, i, arr){
			$('#chef-foods .ID'+el.id).addClass('Selected').find('.btnSelect').html('Selected');
							
		});
		
		$('#popPSOrder').modal('hide');	
		
	});
	
	
	$('#frmReserve').validate({
		errorPlacement: function(error, element) {},
		submitHandler: function(form) {
			
			st = parseInt( $('#start_time').val() );
			en = parseInt( $('#end_time').val() );
			if( en == 0 )en = 24;
			if( st >= en ){
				BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
				BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.SEnV+'</p>');
				BAlert.modal();
				return false;
			}
			
			
			var DishIds = '';
			$('#sp_dishes input[type=checkbox]').each(function(index, element) {
				if ($(this).is(":checked")){
					DishIds = DishIds + ',' + $(this).val();
				}
			});
			
			var tDat, tStt, tEnt ;
			tStt = $('#start_time').val();
			tEnt = $('#end_time').val();
			
			DishAvO[thisDate] = { 'date': thisDate, 'start_time': tStt, 'end_time': tEnt };
			
			if( $('#check_all_days').is(':checked')  ){ // Set to All same days 
				$('#check_all_days').prop('checked', false );
				var dy = moment(thisDate, 'YYYY-MM-DD').format('E');
				var mo = moment();
				for(i=0; i<=90; i++){
					mo.add(1, 'day');
					if( mo.format('E') == dy ){
						tDat = mo.format('YYYY-MM-DD');
						DishAvO[tDat] =  { 'date': tDat, 'start_time': tStt, 'end_time': tEnt };
					}
				}
			}
			
			updateCalTbody();
			$('#popAdd').modal('hide');
			//console.log(DishAvO);
		}// submit handler
	});
	
	
	$('#btn-submit').on('click',function(){
		
		if(empty(eventOb.chefs)){
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">Please select at least one chef for your event to proceed!</p>');
			BAlert.modal();
			return;	
		}
		
		var formData = {
				eventData: JSON.stringify(eventOb),
				userId: localStorage.getItem('userId'),
				userToken: localStorage.getItem('userToken')
			};
		
		$.ajax({
			type: "POST", dataType: 'json', url: ServerAjax+"?h=createEvent", data: formData,
			beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
			complete: function() { waitingDialog.hide(); },
		}).fail(  ajaxError )
		.done(function(data){
			if (data.Success == 'true') {
				
				
				BAlert.find('.modal-header h3').html('<i class="fa check"></i>'+cLan.Success);
				BAlert.find('.modal-body').html('<p class="text-success">'+cLan.s128+'</p>');
				BAlert.find('button').on("click", function(){
					document.location = 'events-list.html';
				});
				BAlert.modal();
				
				
			}
			if (data.JS) { eval(data.JS); }
		}); // ajax	
		
	});
		
});


function loadDishes(chef_id){
	formData = 'chef_id='+chef_id+'&DishAv=1';
	//console.log(formData);
	$.ajax({
		type: "POST", dataType: 'json', url: ServerAjax+"?h=getDishes", data: formData,
		beforeSend: function() { $('#spAvDishesPS ul').empty().append('<li class="list-group-item"><img src="images/wait.gif" alt="" /></li>');  },
		complete: function() {  },
	}).fail(  ajaxError )
	.done(function(data){
		if (data.Success == 'true') {
			if(data.Count > 0 ){
				dishData = data.Dishes;
				
				var ExistingDishes = [];
				if(!empty(eventOb.chefs)){
					eventOb.chefs.forEach(function (el, i, arr){
						if(el.id==chef_id){
							el.dishes.forEach(function (el2, i2, arr2){
								ExistingDishes[el2.id]=1;
							});
						}
					});	
				}
				

				$('#spAvDishesPS ul').empty();
				for (var i = 0; i < dishData.length; i++) {
					if(  dishData[i].availability & 4 ){
						var checked = (ExistingDishes[dishData[i].id]==1)?'CHECKED':'';
						$('#spAvDishesPS ul').append('<li class="list-group-item">'+
							'<input type="checkbox" data-price="'+dishData[i].price+'" data-name="'+dishData[i].dish_name+'" '+checked+' value="'+dishData[i].id+'"> '+dishData[i].dish_name+
							'<div class="spDishD">'+cLan.Price+' : $'+dishData[i].price+ '</div></li>');
					} 
				}
				
			}else{
				$('#chef-foods').html('<center>No Dishes Found</center>');
			}
		}else { 
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+data.Msg+'</p>');
			BAlert.modal();
		}
		if (data.JS) { eval(data.JS); }
		
	}); // ajax	
}

function loadPageData(){
	formData = 'eDate='+eventOb.date+'&eTime='+eventOb.time; // < getDishies + delivery schedure 
	$.ajax({
		type: "POST", dataType: 'json', url: ServerAjax+"?h=getChefsForEvent", data: formData,
		beforeSend: function() { $('div.aLoading').show();  },
		complete: function() { $('div.aLoading').hide(); },
	}).fail(  ajaxError )
	.done(function(data){
		if (data.Success == 'true') {
			if(!empty(data.Rs)){
				chData = data.Rs;
				$DTemp = $('.food-listing');
				for (var i = 0; i < chData.length; i++) {
					$copy = $DTemp.clone().removeClass('hidden');
					$copy.addClass( 'ID'+chData[i].id );
					$copy.find('img.img-responsive').prop('src', 'http://mobileapi.foodiesys.com/foodie-mssql/pics/'+chData[i].image1);
					$copy.find('h4.dishTitle').html( chData[i].company );
					
					//PS_charges
					var ArTab = [[0,0,0],[0,0,0],[0,0,0]];
					if(!empty(chData[i].ps_travel_charges)){
						var ArTab = [[0,0,0],[0,0,0],[0,0,0]];
						var tmpTbl = chData[i].ps_travel_charges;
						var rows = tmpTbl.split(';');
						for(ii=0;ii<rows.length;ii++){
							var cells = rows[ii].split('|');
							for(j=0;j<cells.length;j++){
								ArTab[ii][j] = parseFloat(cells[j]);
							}
						}
					}

					var Dst = distance( eventOb.lat, eventOb.lng, chData[i].lat, chData[i].lng, 'M');
					$copy.find('div.byChef').html( '<span>'+Dst.toFixed(1)+' miles away</span><button type="button" class="btn btn-warning btn-sm btnSelect pull-right" data-id="'+chData[i].id+'">Select Chef</button>'  );
					
					$copy.appendTo('#chef-foods');
					
					var Pschg = 0;
					if( Dst >= ArTab[0][0] && Dst < ArTab[0][1]  ) Pschg = ArTab[0][2];
					if( Dst >= ArTab[1][0] && Dst < ArTab[1][1]  ) Pschg = ArTab[1][2];
					if( Dst >= ArTab[2][0] && Dst < ArTab[2][1]  ) Pschg = ArTab[2][2];
					$('#PS_charges').html('$'+Pschg.toFixed(2));
					$('#hPS_charges').val( Pschg.toFixed(2) );
				}
				//$DTemp.remove();
			}else{
				$('#chef-foods').html('<center>No chefs available near you!</center>');
			}
		}else { 
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+data.Msg+'</p>');
			BAlert.modal();
		}
		if (data.JS) { eval(data.JS); }
	
	}); // ajax	
}


</script>
</body>
</html>